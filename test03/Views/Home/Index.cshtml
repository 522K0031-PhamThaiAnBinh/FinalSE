@{
    ViewBag.Title = "Home Page";
}

<main>
    <section class="row" aria-labelledby="aspnetTitle">
        <h1 id="title">KTPham Restaurant</h1>
        <p class="lead">Welcome to our restaurant.</p>
    </section>
</main>

<a href="#" class="btn btn-primary" id="book-table-btn">Book a table</a>

<!-- Modal for Choosing Reservation Type -->
<div class="modal" id="choice-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Choose Reservation Type</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Please select an option:</p>
                <button class="btn btn-primary" id="table-only-btn">Table Reservation Only</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Reservation -->
<div class="modal fade" id="reservation-modal" tabindex="-1" role="dialog" aria-labelledby="reservation-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservation-modal-label">Book a Table</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Reservation Form -->
                <form id="reservation-form">
                    <!-- Customer Information -->
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" class="form-control" id="firstName" name="firstName" required>
                    </div>

                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" class="form-control" id="lastName" name="lastName" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="text" class="form-control" id="phone" name="Phone" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="Email" required>
                    </div>

                    <!-- Reservation Information -->
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" class="form-control" id="date" name="ReservationDate" required>
                    </div>

                    <div class="form-group">
                        <label for="time">Booking Time</label>
                        <input type="time" class="form-control" id="time" name="ReservationTime" required>
                    </div>

                    <div class="form-group">
                        <label for="guests">Number of Guests</label>
                        <input type="number" class="form-control" id="guests" name="NumberOfGuests" required>
                    </div>

                    <div class="form-group">
                        <label for="specialInstructions">Special Instructions</label>
                        <textarea class="form-control" id="specialInstructions" name="SpecialInstructions"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Reserve</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Complete Your Payment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="form-group">
                        <label for="paymentMethod">Select Payment Method</label>
                        <select id="paymentMethod" class="form-control" required>
                            <option value="">Choose...</option>
                            <option value="Momo">Momo</option>
                            <option value="VNPay">VN Pay</option>
                            <option value="ZaloPay">Zalo Pay</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">Payment Amount</label>
                        <input type="number" id="paymentAmount" class="form-control" readonly />
                    </div>
                    <div class="form-group">
                        <label for="transactionID">Transaction ID</label>
                        <input type="text" id="transactionID" class="form-control" placeholder="Enter Transaction ID" required />
                    </div>
                    <button type="button" id="completePaymentButton" class="btn btn-primary">Complete Payment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    // Open the modal to choose reservation type
    document.getElementById('book-table-btn').addEventListener('click', () => {
            $('#choice-modal').modal('show');
    });

    // Table Reservation Only
    document.getElementById('table-only-btn').addEventListener('click', () => {
            $('#choice-modal').modal('hide');
        $('#reservation-modal').modal('show');
    });

        // Handle Reservation Form Submission
        document.getElementById('reservation-form').addEventListener('submit', function (e) {
            e.preventDefault();

        const formData = new FormData(this);

        fetch('/Reservations/CreateReservation', {
            method: 'POST',
        body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
            // Open the payment modal
            $('#reservation-modal').modal('hide'); // Hide reservation modal
        $('#paymentModal').modal('show'); // Show payment modal

        // Validate and set payment amount
        const amount = data.NumberOfGuests && !isNaN(data.NumberOfGuests)
        ? data.NumberOfGuests * 50
        : 0;
        document.getElementById('paymentAmount').value = amount;

        if (amount === 0) {
            alert('Error: Invalid number of guests.');
        $('#paymentModal').modal('hide');
                    }
                } else {
            alert('Error: ' + data.message);
                }
            })
            .catch(error => {
            console.error('Error:', error);
        alert('An error occurred while submitting your reservation. Please try again.');
            });
    });

        // Handle Payment Form Submission
        document.getElementById('completePaymentButton').addEventListener('click', function () {
        const paymentMethod = document.getElementById('paymentMethod').value;
        const paymentAmount = document.getElementById('paymentAmount').value;
        const transactionID = document.getElementById('transactionID').value;

        // Validate fields
        if (!paymentMethod || !transactionID) {
            alert('Please complete all required fields.');
        return;
        }

        const paymentData = {
            paymentMethod: paymentMethod,
        paymentAmount: paymentAmount,
        transactionID: transactionID,
        };

        fetch('/Payments/ProcessPayment', {
            method: 'POST',
        headers: {'Content-Type': 'application/json' },
        body: JSON.stringify(paymentData),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
            alert('Payment successful! Your reservation is complete.');
        $('#paymentModal').modal('hide'); // Close payment modal
                } else {
            alert('Payment failed: ' + data.message);
                }
            })
            .catch(error => {
            console.error('Error:', error);
        alert('An error occurred while processing your payment. Please try again.');
            });
    });
</script>


<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap Bundle (includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>